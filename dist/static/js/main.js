function loadingStart(){$(".loadingDiv").css("display","")}function loadingStop(){$(".loadingDiv").css("display","none")}var canvasDom,canvasCtx,$upload=$("#upload"),$cropSection=$("#cropSection"),$defaultImgSet=$("#cropLayer img"),$dropArea=$("#dropArea span"),$reChoose=$("#reChoose,#reChooseb"),$toNext=$("#toNext"),$themeBgImg=$("#themeBgImg"),cropGesture=null,themeStlye=1;function cropChoose(){cropStart($upload)}function cropStart(e){$upload.unbind("change"),$upload.one("change",cropChanged),$upload.trigger("click")}function cropChanged(e){if($cropSection.css("visibility","visible"),$("#proSection").css("display","none"),console.log("cropChanged"),console.log(this.files),this.files.length<1)return cropStop(),preventEventPropagation(e);var t=this.files[0],o=new FileReader;return o.onload=function(){var e=this.result,o=new BinaryFile(e),i=EXIF.readFromBinaryFile(o),n=new Image;n.onload=function(){cropLoaded(this),canvasDom.setAttribute("width",$themeBgImg[0].width),canvasDom.setAttribute("height",$themeBgImg[0].height),$("#megaPixImage").css({width:this.width,height:this.height}),loadingStop()},new MegaPixImage(t).render(n,{maxWidth:750,maxHeight:750,orientation:i.Orientation})},o.readAsBinaryString(t),preventEventPropagation(e)}function cropLoaded(e){var t=window.supportTouch;$cropSection.css("display",""),$cropSection.find(".item").each(function(e,t){$(t).unbind("click")}),$cropSection.find(".item").each(function(e,t){$(t).on("click",function(){loadingStart();var t="/dist/static/img/style"+(e+1)+".png";console.log($(this).index()+1,themeStlye);var o=new Image,i=$(this).index();if(i+1==themeStlye)return loadingStop(),!1;o.onload=function(){console.log("loadimg"),$("#themeBgImg")[0].src=o.src,loadingStop(),themeStlye=i+1},o.src=t})}),console.log("cropLoaded");var o=e.width,i=e.height,n=$dropArea.width()/o,a=$dropArea.height()/i,r=n>a?n:a;console.log("imgWidth",o),console.log("imgHeight",i),cropGesture.targetMinWidth=o*r,cropGesture.targetMinHeight=i*r,console.log("ratio",r);var c=.5*($dropArea.width()-cropGesture.targetMinWidth),s=.5*($dropArea.height()-cropGesture.targetMinHeight);console.log("imgOriginX",c,"imgOriginY",s),$defaultImgSet.css("display",""),$defaultImgSet.width(cropGesture.targetMinWidth),$defaultImgSet.height(cropGesture.targetMinHeight),$defaultImgSet.css("left",[c,"px"].join("")),$defaultImgSet.css("top",[s,"px"].join("")),$defaultImgSet[0].src=e.src,cropGesture.unbindEvents(),cropGesture.bindEvents(),$reChoose.unbind(t?"touchend":"click"),$reChoose.on(t?"touchend":"click",cropStart),$toNext.unbind(t?"touchend":"click"),$toNext.on(t?"touchend":"click",cropConfirm)}function cropStop(){console.log("cropStop")}function cropConfirm(e){var t=$defaultImgSet,o=(canvasDom.height,$("#cropLayer .wpr").height(),$("#megaPixImage").width()/t.width()),i={x:parseInt(t.css("left"))||0,y:parseInt(t.css("top"))||0};console.log("imgOrigin x,y",i.x,i.y);var n={width:t.width(),height:t.height()};return console.log("imgSize width height",n.width,n.height),canvasCtx.fillStyle="rgba(255, 255, 255, 0)",canvasCtx.clearRect(0,0,canvasDom.width,canvasDom.height),canvasCtx.drawImage(t[0],Math.abs(i.x)*o,Math.abs(i.y)*o,$dropArea.width()*o,$dropArea.height()*o,$dropArea.offset().left,$dropArea.offset().top,$dropArea.width(),$dropArea.height()),canvasCtx.drawImage($themeBgImg[0],0,0,$themeBgImg.width(),$themeBgImg.height()),setTimeout(function(){proSave(),$cropSection.find(".item").each(function(e,t){$(t).unbind("click")})},0),preventEventPropagation(e)}function proSave(){var e="";window.isAndroid?e=(new JPEGEncoder).encode(canvasCtx.getImageData(0,0,canvasDom.width,canvasDom.height),100,!0):e=canvasDom.toDataURL("image/jpeg",1);var t=new Image;t.onload=function(){$("#proSection img")[0].src=t.src,$("#proSection").css("display","block")},t.src=e}window.indexPageReady=function(){loadingStart(),$("#firstPage .chooseBtn").on("click",cropChoose),window.setTimeout(function(){cropGesture=new EZGesture($dropArea[0],$defaultImgSet[0],{targetMinWidth:1420,targetMinHeight:1420});var e=$("#cropCanvas");canvasDom=e[0],canvasCtx=canvasDom.getContext("2d"),cropGesture.targetMinWidth=canvasDom.width,cropGesture.targetMinHeight=canvasDom.height,$cropSection.css("visibility","hidden"),$cropSection.css("display",""),$cropSection.css("display","none"),$cropSection.css("visibility","visible")},0),loadingStop()},$("#defaultPic div").on("click",function(){console.log("2222")});