function loadingStart(){$(".loadingDiv").css("display","block")}function loadingStop(){$(".loadingDiv").css("display","none")}var _touch=window.supportTouch?"touchend":"click";function openCamera(e){return window.cameraApi.eventCamera(function(t){e(t)},{type:"imageCamera"})}function openGallery(e){return window.cameraApi.eventCamera(function(t){e(t)},{type:"imageAlbum"})}window.indexPageReady=function(){window.setTimeout(function(){cropGesture=new EZGesture($dropArea[0],$defaultImgSet[0],{targetMinWidth:750,targetMinHeight:750});var e=$("#cropCanvas");canvasDom=e[0],canvasCtx=canvasDom.getContext("2d"),cropGesture.targetMinWidth=canvasDom.width,cropGesture.targetMinHeight=canvasDom.height,$cropSection.css("visibility","hidden"),$cropSection.css("display",""),defaultbgStatue&&loadingStop(),window.isAndroid&&(window.cameraApi=B612Kaji.Native.android.Function.getInstance()),document.querySelector("#firstPage .chooseBtn").addEventListener(_touch,function(){document.querySelector("#testTxt").innerHTML="isAndroid:"+window.isAndroid+"_isIos:"+window.isIos+"cameraApi:"+window.cameraApi,$(".firstPage_choose").css("display","flex"),$(".firstPage_choose").unbind(_touch),$(".firstPage_choose").on(_touch,function(){$(".firstPage_choose").css("display","none")}),$(".firstPage_choose .wpr").unbind(_touch),$(".firstPage_choose .wpr").on(_touch,function(e){e.stopPropagation()}),cropStart()},!1),document.querySelector(".openCamera").addEventListener(_touch,function(){openCameraBefore()},!1),document.querySelector(".openGallery").addEventListener(_touch,function(){openGalleryBefore()},!1)},200)};var canvasDom,canvasCtx,$upload=$("#upload"),$cropSection=$("#cropSection"),$defaultImgSet=$("#cropImg"),upqrStatue=!1,initTheme=!1,$dropArea=$("#dropArea"),$reChoose=$("#reChoose,#reChooseb"),$toNext=$("#toNext"),$themeBgImg=$("#themeBgImg"),$themeFoot=$("#theme_foot"),$themeSelectWpr=$(".styleChoose .wpr span"),qrImgs=["qr_guide_t.png","qr_guide1.png","qr_guide2.png","qr_guide3.png","qr_guide4.png"],cropGesture=null,themeStlye=1,themes=[{bg:"./static/img/theme1-bg.jpg",foot:"./static/img/theme1-foot.jpg",sm:"./static/img/theme1-sm.jpg"},{bg:"./static/img/theme2-bg.jpg",foot:"./static/img/theme1-foot.jpg",sm:"./static/img/theme2-sm.jpg"},{bg:"./static/img/theme3-bg.jpg",foot:"./static/img/theme1-foot.jpg",sm:"./static/img/theme3-sm.jpg"}],changeTheme=function(e){loadingStart(),$themeFoot.find("img")[0].style.width="100%",$themeFoot.find("img")[0].src=e.foot,$("#cropLayer").css({height:$("#cropLayer").offset().width,left:($("#cropSection").width()-$("#cropLayer").width())/2});e.cropLayerPos,e.cropLayerWprPos;$("#dropArea").css({width:$("#cropLayer").width(),height:$("#cropLayer").height(),left:$("#cropLayer").offset().left,top:$("#cropLayer").offset().top+$cropSection.scrollTop()});var t=new Image;t.onload=function(){themeBgImg.src=t.src,setTimeout(function(){console.log("initTheme"),loadingStop(),initTheme=!0},260)},t.src=e.bg},zd_qrcode=null;function cropStart(e){initTheme||(changeTheme(themes[0]),loadingStop()),$themeSelectWpr.eq(0).empty(),themes.forEach(function(e,t,o){var i=document.createElement("div"),n=document.createElement("img");n.setAttribute("src",e.sm),n.style.width="100%",i.classList.add("item"),i.appendChild(n),$themeSelectWpr[0].appendChild(i)}),$("#theme_foot span").find(".item").each(function(e,t){$(t).unbind(_touch)}),$("#theme_foot span").find(".item").each(function(e,t){$(t).on(_touch,function(){var t=$(this).index();if(t+1==themeStlye)return loadingStop(),!1;themeStlye=t+1,changeTheme(themes[e])})})}function openCameraBefore(){loadingStart(),openCamera(function(e){if(0==e.length)return loadingStop(),!1;$(".firstPage_choose").css("display","none"),cropChanged(e)})}function openGalleryBefore(){loadingStart(),openGallery(function(e){if(0==e.length)return loadingStop(),!1;$(".firstPage_choose").css("display","none"),cropChanged(e)})}function cropChanged(e){initTheme||changeTheme(themes[0]),$cropSection.css("visibility","visible"),$("#proSection").css("display","none");var t=new Image;t.onload=function(){cropLoaded(this),canvasDom.setAttribute("width",$themeBgImg[0].width),canvasDom.setAttribute("height",$themeBgImg[0].height),$("#megaPixImage").css({width:this.width,height:this.height})},t.src=e}function cropLoaded(e){$cropSection.css("display","");var t=e.width,o=e.height,i=$dropArea.width()/t,n=$dropArea.height()/o,r=i>n?i:n;cropGesture.targetMinWidth=t*r,cropGesture.targetMinHeight=o*r;var a=.5*($dropArea.width()-cropGesture.targetMinWidth),c=.5*($dropArea.height()-cropGesture.targetMinHeight);console.log("cropGesture.targetMinWidth:",cropGesture.targetMinWidth),$defaultImgSet.css("display",""),$defaultImgSet.width(cropGesture.targetMinWidth),$defaultImgSet.height(cropGesture.targetMinHeight),$defaultImgSet.css("left",[a,"px"].join("")),$defaultImgSet.css("top",[c,"px"].join("")),$defaultImgSet[0].src=e.src,$defaultImgSet[0].onload=function(){loadingStop()},initTheme&&loadingStop(),cropGesture.unbindEvents(),cropGesture.bindEvents(),$reChoose.unbind(_touch),$reChoose.on(_touch,toReChoose),$toNext.unbind(_touch),$toNext.on(_touch,cropConfirm),$("#eCode").unbind(_touch),$("#eCode").on(_touch,function(){$("#qrGuide").css("display","")}),$("#qrGuide .return").unbind(_touch),$("#qrGuide .return").on(_touch,function(){$("#qrGuide").css("display","none")}),upqrStatue||($("#qrGuide img").each(function(e,t){t.src="./static/img/"+qrImgs[e]}),loadScript("./static/js/qrcode.js"),loadScript("./static/js/llqrcode.js",function(){upqr()}))}function toReChoose(){$(".firstPage_choose").css("display","flex")}function cropStop(){console.log("cropStop")}function cropConfirm(e){loadingStart();var t=$defaultImgSet,o=(canvasDom.height,$("#cropLayer .wpr").height(),$("#megaPixImage").width()/t.width()),i={x:parseInt(t.css("left"))||0,y:parseInt(t.css("top"))||0};console.log("imgOrigin x,y",i.x,i.y);t.width(),t.height();return canvasCtx.drawImage($themeBgImg[0],0,0,750,993,0,0,$themeBgImg.width(),$themeBgImg.height()),canvasCtx.drawImage(t[0],Math.abs(i.x)*o,Math.abs(i.y)*o,$dropArea.width()*o,$dropArea.height()*o,$dropArea.offset().left,$dropArea.offset().top+$cropSection.scrollTop(),$dropArea.width(),$dropArea.height()),canvasCtx.fillStyle="#fff",canvasCtx.fillRect($("#eCode").offset().left-2,$("#eCode").offset().top+$cropSection.scrollTop()-2,$("#eCode").width(),$("#eCode").height()),canvasCtx.drawImage($("#eCode")[0],0,0,124,124,$("#eCode").offset().left,$("#eCode").offset().top+$cropSection.scrollTop(),$("#eCode").width()+10,$("#eCode").height()+10),setTimeout(function(){loadingStart(),proSave()},0),preventEventPropagation(e)}function proSave(){$(".nextGuide").css("display","flex"),$(".nextGuide .confirm").unbind(_touch),$(".nextGuide .confirm").on(_touch,function(){$(".nextGuide").css("display","none")});var e="";window.isAndroid?e=(new JPEGEncoder).encode(canvasCtx.getImageData(0,0,canvasDom.width,canvasDom.height),200,!0):e=canvasDom.toDataURL("image/jpeg",1);var t=new Image;t.onload=function(){$("#proSection img")[0].src=t.src,$("#proSection").css("display","block"),loadingStop()},t.src=e}function upqr(){function e(e){e.indexOf("error")>-1||e.indexOf("Failed")>-1?alert("请输入有效的收款二维码"):(zd_qrcode.makeCode(String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")),$("#eCode")[0].src=$("#zd_qrcode img")[0].src,$("#qrGuide").css("display","none"),$("#proSection img")[1].src="./static/img/theme1-foot.jpg",loadingStart(),setTimeout(function(){$("#toNext").trigger("click")},260)),$("#handleQR")[0].value=""}var t,o,i;$("#qrGuide .btn").unbind(_touch),$("#qrGuide .btn").on(_touch,function(){alert(0),openGallery(function(e){if(alert(0),$("#testTxt").text(e),0==e.length)return loadingStop(),!1})}),window.File&&window.FileReader&&(t=200,o=150,(i=document.getElementById("qr-canvas")).style.width=t+"px",i.style.height=o+"px",i.width=t,i.height=o,gCtx=i.getContext("2d"),gCtx.clearRect(0,0,t,o),qrcode.callback=e),(zd_qrcode=new QRCode(document.getElementById("zd_qrcode"),{width:100,height:100})).makeCode(""),upqrStatue=!0}